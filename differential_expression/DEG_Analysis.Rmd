---
title: "Differential Expression - Activated vs Resting"
author: "Mariah Lee"
date: "Last Updated: 06.21.2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,      # Show code in the HTML (set to FALSE to hide code)
  warning = FALSE,  # Hide warnings in the output
  message = FALSE,  # Hide messages in the output
  fig.width = 7,    # Default figure width
  fig.height = 5,   # Default figure height
  fig.align = "center" # Center figures
)
```

## Overview

This R Markdown document outlines a reproducible workflow for differential expression (DE) analysis of long non-coding RNAs (lncRNAs) using RNA-seq quantification data generated by Salmon and imported with tximport. The primary objective is to identify lncRNAs that are differentially expressed between experimental conditions.

This analysis uses two widely adopted Bioconductor packages:

 - `edgeR`: A count-based method that models RNA-seq data using the negative binomial distribution, particularly well-suited for small sample sizes and low-count genes.

 - `limma`/`voom`: Applies linear modeling to RNA-seq data after transforming counts to log2 counts per million (logCPM) with the voom method, enabling robust variance modeling and empirical Bayes moderation for increased statistical power.

Key steps in this workflow:

 - Import transcript-level quantification data from Salmon.
 - Map transcripts to genes and filter for lncRNAs.
 - Normalize and transform count data for downstream analysis.
 - Perform differential expression analysis using edgeR and limma/voom.
 - Summarize and visualize results.
 
## Load libraries

```{r libraries}
# List of required packages
cran_packages <- c("readr", "tidyverse", "knitr", "ggplot2", "ggrepel")
bioc_packages <- c("tximport", "edgeR", "DESeq2", "biomaRt")

# Function to check, install, and load packages
install_and_load <- function(pkg, bioc = FALSE) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    if (bioc) {
      if (!requireNamespace("BiocManager", quietly = TRUE))
        install.packages("BiocManager")
      BiocManager::install(pkg, ask = FALSE, update = FALSE)
    } else {
      install.packages(pkg)
    }
  }
  library(pkg, character.only = TRUE)
}

# Install and load CRAN packages
for (pkg in cran_packages) {
  install_and_load(pkg, bioc = FALSE)
}

# Install and load Bioconductor packages
for (pkg in bioc_packages) {
  install_and_load(pkg, bioc = TRUE)
}
```

## Detect and List All Sample Quantification Files

This code chunk scans the `results/salmon` directory, identifies all sample subfolders (based on their naming pattern), and constructs a named vector of paths to each sample’s quant.sf file. This ensures the analysis will automatically include all current and future samples without manual updates.

```{r samples, echo=FALSE}
# List all entries in the results/salmon directory
all_entries <- list.dirs("../results/salmon", full.names = FALSE, recursive = FALSE)

# Filter to keep only sample folders (exclude known non-sample files/folders)
# You may want to exclude folders like 'deseq2_qc' or any that do not match the sample naming pattern
sample_folders <- all_entries[grepl("^SRR", all_entries)]

# Construct full paths to quant.sf for each sample
files <- file.path("../results/salmon", sample_folders, "quant.sf")
names(files) <- sample_folders

# Check result
head(files)
```

## Import Quantification Data and Summarize to Gene Level

This step imports transcript-level quantification files from Salmon for all detected samples, then uses the existing transcript-to-gene mapping (tx2gene.tsv) to summarize the data at the gene level. The resulting gene-level matrices (counts, abundance, and effective length) are ready for downstream differential expression analysis with edgeR or limma/voom.

```{r tximport}
# Read the transcript-to-gene mapping file
tx2gene <- readr::read_tsv("../results/salmon/tx2gene.tsv", col_types = "cc")

# Import quantification data and summarize to gene level
txi <- tximport(files, type = "salmon", tx2gene = tx2gene, countsFromAbundance = "no")

# Inspect the structure of the imported data
str(txi)
```

## Extract Gene-Level Counts for Differential Expression Analysis

After importing data with tximport, you should extract the gene-level counts matrix into its own dataframe for use with edgeR or limma/voom. The other matrices—abundance and length—can be kept for interpretation, visualization, or quality control, but are not directly needed for the main DE analysis.

```{r extract}
# Extract the counts matrix from tximport output
counts <- txi$counts
counts[1:5, 1:5]
```

## Visualizing Gene Expression Data

Before starting differential expression analysis, it’s important to visualize the gene expression data to assess sample quality and relationships. Two common approaches are box plots (to check for distribution and outliers) and multidimensional scaling (MDS) plots (to examine sample similarity).

### Box Plot of Log-Transformed Counts

This plot shows the distribution of log2-transformed gene counts for each sample, helping you spot outliers or batch effects.

```{r boxplot}
# Log-transform counts for variance stabilization
log_counts <- log2(counts + 1)

# Convert to long format for ggplot2
log_counts_long <- as.data.frame(log_counts)
log_counts_long$Gene <- rownames(log_counts_long)
log_counts_long <- tidyr::pivot_longer(
  log_counts_long, 
  cols = -Gene,
  names_to = "Sample",
  values_to = "Log2_Count"
)

# Box plot
ggplot(log_counts_long, aes(x = Sample, y = Log2_Count)) +
  geom_boxplot() +
  labs(title = "Distribution of Log2 Gene Counts per Sample",
       y = "Log2(Counts + 1)", x = "Sample") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### MDS Plot of Samples

An MDS plot visualizes the relationships among samples based on their overall gene expression profiles. Samples that cluster together are more similar in expression.

```{r mds}
dge <- DGEList(counts = counts)
logCPM <- cpm(dge, log = TRUE)

# MDS plot using edgeR
plotMDS(logCPM, labels = colnames(counts), main = "MDS Plot of Samples")
```

## Add Gene Names/Symbols to Counts

```{r gene_symbols}
# Connect to Ensembl Mart
ensembl <- useEnsembl(biomart = "ensembl", 
                      dataset = "hsapiens_gene_ensembl", 
                      host = "https://www.ensembl.org")

# Get gene IDs from your data
gene_ids_with_versions <- rownames(txi$counts)

# Remove the ".#" version suffix from the Ensembl IDs
gene_ids <- sub("\\..*", "", gene_ids_with_versions)

gene_annotations <- getBM(
  attributes = c('ensembl_gene_id', 'hgnc_symbol', 'description', 'gene_biotype'),
  filters = 'ensembl_gene_id',
  values = gene_ids,
  mart = ensembl
)

# Identify Ensembl IDs that map to more than one unique HGNC symbol
multi_symbol_mappings <- gene_annotations %>%
  filter(hgnc_symbol != "") %>% # Only consider entries with an actual symbol
  group_by(ensembl_gene_id) %>%
  summarise(
    num_unique_symbols = n_distinct(hgnc_symbol),
    symbols = paste(sort(unique(hgnc_symbol)), collapse = "; ") # For inspection
  ) %>%
  filter(num_unique_symbols > 1)
```

## Rename txi rows with HGNC Symbols

```{r replace_ids}
# Add full gene IDs with versions to gene_annotations
gene_annotations$gene_id_with_version <- gene_ids_with_versions[
  match(gene_annotations$ensembl_gene_id, gene_ids)
]

# Check alignment: each row in gene_annotations should match its corresponding row in counts
stopifnot(all(
  gene_annotations$ensembl_gene_id == sub("\\..*", "", gene_annotations$gene_id_with_version)
))

# Create a named vector: names = gene_id_with_version, values = gene symbol (fallback to ID)
gene_symbol_map <- gene_annotations %>%
  dplyr::select(gene_id_with_version, hgnc_symbol, gene_biotype) %>%
  mutate(symbol_or_id = ifelse(hgnc_symbol == "", gene_id_with_version, hgnc_symbol)) %>%
  distinct(gene_id_with_version, .keep_all = TRUE)

# Reassign row names in all txi matrices
for (mat in c("counts", "abundance", "length")) {
  rownames(txi[[mat]]) <- gene_symbol_map$symbol_or_id[
    match(rownames(txi[[mat]]), gene_symbol_map$gene_id_with_version)
  ]
}
```

## Load and Prepare Sample Metadata

This step reads the metadata CSV file into R, sets the sample IDs as row names for easy matching with quantification data, and checks that all samples in the expression matrix have corresponding metadata. This ensures the downstream analyses and visualizations can incorporate sample attributes like treatment, age, and sex.

```{r metadata}
# Load the metadata CSV file
metadata <- readr::read_csv("../metadata/sample_metadata.csv")

# Check that all sample names in the counts matrix are present in the metadata
all(colnames(counts) %in% metadata$SRR_ID)
# Should return TRUE; if not, check for mismatches or typos

# View the first few rows of the metadata to confirm successful import
head(metadata)
```

This chunk processes the metadata to add biologically relevant columns for downstream subsetting and analysis.

```{r edit_metadata}
# Add Cell_Type by extracting 'CD4' or 'CD8' from Biosample_term_name
metadata$Cell_Type <- str_extract(metadata$Biosample_term_name, "CD4|CD8")

# Add Cell_State based on keywords in Biosample_term_name
metadata$Cell_State <- "mature" # Default
metadata$Cell_State[grepl("naive", metadata$Biosample_term_name, ignore.case = TRUE)] <- "naive"
metadata$Cell_State[grepl("memory", metadata$Biosample_term_name, ignore.case = TRUE)] <- "memory"

# Rename 'Treatment' to 'Activation_Status' and recode values
metadata <- metadata %>%
  mutate(Activation_Status = recode(Treatment,
                                    "no_treatment" = "resting",
                                    "treatment" = "activated")) %>%
  dplyr::select(-Treatment)

# View the updated metadata
head(metadata)
```

```{r subset}
# All CD4+ T cells (Activated vs Resting)
meta_cd4_all <- metadata %>%
  filter(Cell_Type == "CD4")

# Naive CD4+ T cells (Activated vs Resting)
meta_cd4_naive <- metadata %>%
  filter(Cell_Type == "CD4", Cell_State == "naive")

# Memory CD4+ T cells (Activated vs Resting)
meta_cd4_memory <- metadata %>%
  filter(Cell_Type == "CD4", Cell_State == "memory")


# Function to subset txi object based on sample IDs
subset_txi <- function(txi, sample_ids) {
  txi_subset <- list(
    counts = txi$counts[, sample_ids, drop=FALSE],
    abundance = txi$abundance[, sample_ids, drop=FALSE],
    length = txi$length[, sample_ids, drop=FALSE],
    countsFromAbundance = txi$countsFromAbundance
  )
}

# Subset txi for each comparison
txi_cd4_all    <- subset_txi(txi, meta_cd4_all$SRR_ID)
txi_cd4_naive  <- subset_txi(txi, meta_cd4_naive$SRR_ID)
txi_cd4_memory <- subset_txi(txi, meta_cd4_memory$SRR_ID)

# Save each subset
saveRDS(txi_cd4_all, "txi_cd4_all.rds")
saveRDS(meta_cd4_all, "meta_cd4_all.rds")

saveRDS(txi_cd4_naive, "txi_cd4_naive.rds")
saveRDS(meta_cd4_naive, "meta_cd4_naive.rds")

saveRDS(txi_cd4_memory, "txi_cd4_memory.rds")
saveRDS(meta_cd4_memory, "meta_cd4_memory.rds")
```

## Genes of Interest

```{r lncRNAs}
# Filter the gene_annotations to identify genes with 'lncRNA' biotype
lncrna_list <- gene_annotations %>%
  filter(gene_biotype == "lncRNA")

# Display the first few entries and the dimensions of the lncRNA list
cat("First few entries of the lncRNA list:\n")
print(head(lncrna_list))
cat("\nDimensions of the lncRNA list (rows, columns): ", dim(lncrna_list), "\n")
```

## Create DESeq2 Objects for each comparison

```{r objects}
dds_cd4_all <- DESeqDataSetFromTximport(
  txi = txi_cd4_all,
  colData = meta_cd4_all,
  design = ~ Activation_Status
)

dds_cd4_naive <- DESeqDataSetFromTximport(
  txi = txi_cd4_naive,
  colData = meta_cd4_naive,
  design = ~ Activation_Status
)

dds_cd4_memory <- DESeqDataSetFromTximport(
  txi = txi_cd4_memory,
  colData = meta_cd4_memory,
  design = ~ Activation_Status
)
```

# 1.1 Differential Expression Analysis: Activated vs Resting CD4⁺ T Cells

This section performs the core differential expression analysis using the `DESeq2` package. For each comparison, it sets the appropriate factor levels, runs the `DESeq()` function (which handles internal normalization and dispersion estimation), and extracts the differential expression results.

```{r results_1.1}
# Set factor levels for the 'Activation_Status' variable
dds_cd4_all$Activation_Status <- factor(dds_cd4_all$Activation_Status, 
                                        levels = c("resting", "activated"))
# Run the DESeq2 analysis pipeline
dds_cd4_all <- DESeq(dds_cd4_all)

# Extract results for the specific contrast
results_cd4_all <- results(dds_cd4_all, contrast = 
                             c("Activation_Status", "activated", "resting"))

# Order results by adjusted p-value (padj) for easy interpretation
results_cd4_all <- results_cd4_all[order(results_cd4_all$padj), ]

# View the top differentially expressed genes
head(results_cd4_all)
```

## Visualization: Volcano Plot

This volcano plot visualizes the differential gene expression results for Activated versus Resting CD4+ T cells. Positive LFC values mean the gene is more highly expressed in Activated CD4+ T cells compared to Resting CD4+ T cells. Negative LFC values mean the gene is more highly expressed in Resting CD4+ T cells compared to Activated CD4+ T cells.

```{r volcano_1.1}
# Convert DESeqResults object to a tibble for easier plotting with ggplot2
plot_data_cd4_all <- as_tibble(results_cd4_all, rownames = "gene_id")

# Add the 'gene_biotype' to each gene entry in the plotting data.
plot_data_cd4_all <- plot_data_cd4_all %>%
  left_join(gene_symbol_map %>%
              dplyr::select(symbol_or_id, gene_biotype),
            by = c("gene_id" = "symbol_or_id"))

# Define significance and fold change thresholds
padj_threshold <- 0.05
lfc_threshold <- 1 # For a 2-fold change. Use 0.58 for 1.5-fold change (log2(1.5))

# Create a 'Significance' category for coloring the points
plot_data_cd4_all <- plot_data_cd4_all %>%
  mutate(
    Significance = case_when(
      padj < padj_threshold & log2FoldChange > lfc_threshold ~ "Significantly Upregulated",
      padj < padj_threshold & log2FoldChange < -lfc_threshold ~ "Significantly Downregulated",
      TRUE ~ "Not Significant"
    )
  )

# Set the order of levels for consistent plotting colors
plot_data_cd4_all$Significance <- factor(
  plot_data_cd4_all$Significance,
  levels = c("Significantly Upregulated", "Significantly Downregulated", "Not Significant")
)

# Filter for genes that are both significant AND have the 'lncRNA' biotype.
labels_data <- plot_data_cd4_all %>%
  filter(Significance %in% c("Significantly Upregulated", "Significantly Downregulated")) %>%
  filter(gene_biotype == "lncRNA") %>%
  arrange(padj) %>%
  slice_head(n = 20)

# Generate the Volcano Plot
ggplot(plot_data_cd4_all, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = Significance), alpha = 0.8, size = 1) +
  scale_color_manual(
    values = c(
      "Significantly Upregulated" = "red",
      "Significantly Downregulated" = "blue",
      "Not Significant" = "grey"
    )
  ) +
  geom_vline(xintercept = c(-lfc_threshold, lfc_threshold), 
             linetype = "dashed", color = "darkgreen") +
  geom_hline(yintercept = -log10(padj_threshold), 
             linetype = "dashed", color = "darkgreen") +
  # Add labels using geom_text_repel, applying only to the filtered 'labels_data'
  geom_text_repel(
    data = labels_data,
    aes(label = gene_id), # Use the gene_id (which now contains HGNC symbol) for labels
    size = 2.5,
    box.padding = 0.5,   # Space around the text
    point.padding = 0.5, # Space between text and point
    max.overlaps = Inf,  # Try to repel all labels (can be slow for many)
    min.segment.length = 0.1
  ) +
  labs(
    title = "Activated vs. Resting CD4+ T Cells",
    x = "Log2 Fold Change (Activated / Resting)",
    y = "-log10(Adjusted p-value)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.title = element_blank()
  )
```

# 1.2 Comparing Activated *Naive* CD4+ T cells vs. Resting *Naive* CD+ T cells

This section performs the core differential expression analysis using the DESeq2 package for the naive CD4+ T cell subset. It sets the appropriate factor levels, runs the DESeq() function (which handles internal normalization and dispersion estimation), and extracts the differential expression results.

```{r results_1.2}
# Set factor levels for the 'Activation_Status' variable for naive CD4+ cells
dds_cd4_naive$Activation_Status <- factor(dds_cd4_naive$Activation_Status,
                                          levels = c("resting", "activated"))
# Run the DESeq2 analysis pipeline for naive CD4+ cells
dds_cd4_naive <- DESeq(dds_cd4_naive)

# Extract results for the specific contrast for naive CD4+ cells
results_cd4_naive <- results(dds_cd4_naive, contrast =
                               c("Activation_Status", "activated", "resting"))

# Order results by adjusted p-value (padj) for easy interpretation
results_cd4_naive <- results_cd4_naive[order(results_cd4_naive$padj), ]

# View the top differentially expressed genes
head(results_cd4_naive)
```

## Visualization: Volcano Plot

This volcano plot visualizes the differential gene expression results for Activated versus Resting naive CD4+ T cells. Positive LFC values mean the gene is more highly expressed in Activated naive CD4+ T cells compared to Resting naive CD4+ T cells. Negative LFC values mean the gene is more highly expressed in Resting naive CD4+ T cells compared to Activated naive CD4+ T cells.

```{r volcano_1.2}
# Convert DESeqResults object to a tibble for easier plotting with ggplot2
plot_data_cd4_naive <- as_tibble(results_cd4_naive, rownames = "gene_id")

# Add the 'gene_biotype' to each gene entry in the plotting data.
plot_data_cd4_naive <- plot_data_cd4_naive %>%
  left_join(gene_symbol_map %>%
              dplyr::select(symbol_or_id, gene_biotype),
            by = c("gene_id" = "symbol_or_id"))

# Define significance and fold change thresholds
padj_threshold <- 0.05
lfc_threshold <- 1 # For a 2-fold change. Use 0.58 for 1.5-fold change (log2(1.5))

# Create a 'Significance' category for coloring the points
plot_data_cd4_naive <- plot_data_cd4_naive %>%
  mutate(
    Significance = case_when(
      padj < padj_threshold & log2FoldChange > lfc_threshold ~ "Significantly Upregulated",
      padj < padj_threshold & log2FoldChange < -lfc_threshold ~ "Significantly Downregulated",
      TRUE ~ "Not Significant"
    )
  )

# Set the order of levels for consistent plotting colors
plot_data_cd4_naive$Significance <- factor(
  plot_data_cd4_naive$Significance,
  levels = c("Significantly Upregulated", "Significantly Downregulated", "Not Significant")
)

# Filter for significant genes to label
naive_labels <- plot_data_cd4_naive %>%
  filter(Significance %in% c("Significantly Upregulated", "Significantly Downregulated")) %>%
  filter(gene_biotype == "lncRNA") %>%
  arrange(padj) %>%
  slice_head(n = 20)

# Generate the Volcano Plot
ggplot(plot_data_cd4_naive, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = Significance), alpha = 0.8, size = 1) +
  scale_color_manual(
    values = c(
      "Significantly Upregulated" = "red",
      "Significantly Downregulated" = "blue",
      "Not Significant" = "grey"
    )
  ) +
  geom_vline(xintercept = c(-lfc_threshold, lfc_threshold), 
             linetype = "dashed", color = "darkgreen") +
  geom_hline(yintercept = -log10(padj_threshold), 
             linetype = "dashed", color = "darkgreen") +
  # Add labels using geom_text_repel, applying only to the filtered 'naive_labels'
  geom_text_repel(
    data = naive_labels,
    aes(label = gene_id),
    size = 2.5,
    box.padding = 0.5,   # Space around the text
    point.padding = 0.5, # Space between text and point
    max.overlaps = Inf,  # Try to repel all labels (can be slow for many)
    min.segment.length = 0.1
  ) +
  labs(
    title = "Activated vs. Resting Naive CD4+ T Cells",
    x = "Log2 Fold Change (Activated / Resting)",
    y = "-log10(Adjusted p-value)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.title = element_blank()
  )
```

# 1.3 Comparing Activated *Memory* CD4+ T cells vs. Resting *Memory* CD+ T cells

```{r results_1.3}
# Set factor levels for the 'Activation_Status' variable for memory CD4+ cells
dds_cd4_memory$Activation_Status <- factor(dds_cd4_memory$Activation_Status,
                                          levels = c("resting", "activated"))
# Run the DESeq2 analysis pipeline for memory CD4+ cells
dds_cd4_memory <- DESeq(dds_cd4_memory)

# Extract results for the specific contrast for memory CD4+ cells
results_cd4_memory <- results(dds_cd4_memory, contrast =
                               c("Activation_Status", "activated", "resting"))

# Order results by adjusted p-value (padj) for easy interpretation
results_cd4_memory <- results_cd4_memory[order(results_cd4_memory$padj), ]

# View the top differentially expressed genes
head(results_cd4_memory)
```

## Visualization: Volcano Plot

```{r volcano_1.3}
# Convert DESeqResults object to a tibble for easier plotting with ggplot2
plot_data_cd4_memory <- as_tibble(results_cd4_memory, rownames = "gene_id")

# Add the 'gene_biotype' to each gene entry in the plotting data.
plot_data_cd4_memory <- plot_data_cd4_memory %>%
  left_join(gene_symbol_map %>%
              dplyr::select(symbol_or_id, gene_biotype),
            by = c("gene_id" = "symbol_or_id"))

# Define significance and fold change thresholds
padj_threshold <- 0.05
lfc_threshold <- 1 # For a 2-fold change. Use 0.58 for 1.5-fold change (log2(1.5))

# Create a 'Significance' category for coloring the points
plot_data_cd4_memory <- plot_data_cd4_memory %>%
  mutate(
    Significance = case_when(
      padj < padj_threshold & log2FoldChange > lfc_threshold ~ "Significantly Upregulated",
      padj < padj_threshold & log2FoldChange < -lfc_threshold ~ "Significantly Downregulated",
      TRUE ~ "Not Significant"
    )
  )

# Set the order of levels for consistent plotting colors
plot_data_cd4_memory$Significance <- factor(
  plot_data_cd4_memory$Significance,
  levels = c("Significantly Upregulated", "Significantly Downregulated", "Not Significant")
)

# Filter for significant genes to label
memory_labels <- plot_data_cd4_memory %>%
  filter(Significance %in% c("Significantly Upregulated", "Significantly Downregulated")) %>%
  filter(gene_biotype == "lncRNA") %>%
  arrange(padj) %>%
  slice_head(n = 20)

# Generate the Volcano Plot
ggplot(plot_data_cd4_memory, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = Significance), alpha = 0.8, size = 1) +
  scale_color_manual(
    values = c(
      "Significantly Upregulated" = "red",
      "Significantly Downregulated" = "blue",
      "Not Significant" = "grey"
    )
  ) +
  geom_vline(xintercept = c(-lfc_threshold, lfc_threshold), 
             linetype = "dashed", color = "darkgreen") +
  geom_hline(yintercept = -log10(padj_threshold), 
             linetype = "dashed", color = "darkgreen") +
  # Add labels using geom_text_repel, applying only to the filtered 'memory_labels'
  geom_text_repel(
    data = memory_labels,
    aes(label = gene_id),
    size = 2.5,
    box.padding = 0.5,   # Space around the text
    point.padding = 0.5, # Space between text and point
    max.overlaps = Inf,  # Try to repel all labels (can be slow for many)
    min.segment.length = 0.1
  ) +
  labs(
    title = "Activated vs. Resting Memory CD4+ T Cells",
    x = "Log2 Fold Change (Activated / Resting)",
    y = "-log10(Adjusted p-value)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.title = element_blank()
  )
```

## Saving the Results

```{r save}
# Define a helper function to filter and write TSV
save_significant_results <- function(df, filename) {
  df %>%
    filter(padj <= 0.05, abs(log2FoldChange) >= 1) %>%
    arrange(padj) %>%
    write_tsv(filename)
}

# Apply to each dataset
save_significant_results(plot_data_cd4_all, "results_cd4_all_significant.tsv")
save_significant_results(plot_data_cd4_naive, "results_cd4_naive_significant.tsv")
save_significant_results(plot_data_cd4_memory, "results_cd4_memory_significant.tsv")
```

## Version Control

```{r versions}
# Get loaded packages and versions
packages <- sessionInfo()$otherPkgs
pkg_info <- tibble::tibble(
  Package = names(packages),
  Version = sapply(packages, function(pkg) pkg$Version)
)

# Save to text file
readr::write_tsv(pkg_info, "package_versions.txt")
```
